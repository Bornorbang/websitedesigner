{% extends 'master.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ course.title }} - {{ course.subtitle }}{% endblock %}

{% block meta_description %}{{ course.meta_description|default:course.short_description }}{% endblock %}

{% block og_title %}{{ course.title }} Course - {{ course.subtitle }}{% endblock %}

{% block og_description %}{{ course.meta_description|default:course.short_description }}{% endblock %}

{% block og_image %}{% if course.thumbnail %}{{ request.scheme }}://{{ request.get_host }}{{ course.thumbnail.url }}{% else %}{% static 'img/favicon.png' %}{% endif %}{% endblock %}

{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}

{% block extra_meta %}
<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@websitedesignerng">
<meta name="twitter:url" content="{{ request.build_absolute_uri }}">
<meta name="twitter:title" content="{{ course.title }} Course - {{ course.subtitle }}">
<meta name="twitter:description" content="{{ course.meta_description|default:course.short_description }}">
{% if course.thumbnail %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ course.thumbnail.url }}">
{% else %}
<meta name="twitter:image" content="https://host-students.com/app/uploads/2023/05/1-6.webp">
{% endif %}

<!-- Additional Course-specific Meta Tags -->
<meta name="author" content="{{ course.instructor.name }}">
<meta name="publisher" content="Website Designer Nigeria">
<meta property="article:author" content="{{ course.instructor.name }}">
<meta property="course:price:amount" content="{{ course.price }}">
<meta property="course:price:currency" content="NGN">
<meta property="course:instructor" content="{{ course.instructor.name }}">
<meta property="course:category" content="{{ course.category.name }}">
<meta property="course:duration" content="{% if course.total_duration %}{{ course.total_duration }}{% else %}180{% endif %} minutes">
<link rel="canonical" href="{{ request.build_absolute_uri }}">

<!-- Schema.org Course Markup -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Course",
  "name": "{{ course.title }}",
  "description": "{{ course.meta_description|default:course.short_description|escapejs }}",
  "image": "{% if course.thumbnail %}{{ request.scheme }}://{{ request.get_host }}{{ course.thumbnail.url }}{% else %}https://host-students.com/app/uploads/2023/05/1-6.webp{% endif %}",
  "provider": {
    "@type": "Organization",
    "name": "Website Designer Nigeria",
    "url": "https://websitedesigner.ng"
  },
  "instructor": {
    "@type": "Person",
    "name": "{{ course.instructor.name }}"
  },
  "educationalLevel": "Beginner to Advanced",
  "courseMode": "Online",
  "hasCourseInstance": {
    "@type": "CourseInstance",
    "courseMode": "Online",
    "instructor": {
      "@type": "Person",
      "name": "{{ course.instructor.name }}"
    }
  },
  {% if not course.is_free %}
  "offers": {
    "@type": "Offer",
    "price": "{{ course.price }}",
    "priceCurrency": "NGN",
    "availability": "https://schema.org/InStock",
    "validFrom": "{{ course.created_at|date:'Y-m-d' }}"
  },
  {% endif %}
  "totalTime": "PT{% if course.total_duration %}{{ course.total_duration }}{% else %}180{% endif %}M",
  "teaches": "{{ course.short_description|escapejs }}",
  "url": "{{ request.build_absolute_uri }}"
}
</script>
{% endblock %}

{% block extra_head %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'css/course.css' %}">
{% endblock %}

{% block content %}
<!-- Course Hero Section -->
<section class="course-hero">
    <div class="max-w-7xl mx-auto px-6">
        <div class="flex flex-wrap -mx-4">
            <div class="w-full px-4" style="width: 100%;">
                <style>
                    @media (min-width: 1024px) {
                        .course-hero .hero-content {
                            width: 71%;
                        }
                    }
                    @media (min-width: 1280px) {
                        .course-hero .hero-content {
                            width: 76%;
                        }
                    }
                </style>
                <div class="hero-content">
                <h1>{{ course.title }}{% if course.subtitle %} - {{ course.subtitle }}{% endif %}</h1>
                
                {% if course.short_description %}
                <p class="subtitle">{{ course.short_description }}</p>
                {% endif %}

                <div class="course-stats">
                    {% if course.rating > 0 %}
                    <div class="rating-section">
                        <span class="rating-number">{{ course.rating }}</span>
                        <div class="stars">
                            {% for i in "12345" %}
                                {% if forloop.counter <= course.rating|floatformat:0 %}
                                    <i class="fas fa-star"></i>
                                {% elif forloop.counter <= course.rating|add:0.5 %}
                                    <i class="fas fa-star-half-alt"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span>({{ course.reviews_count }} rating{{ course.reviews_count|pluralize }})</span>
                    </div>
                    {% endif %}

                    <div>
                        <i class="fas fa-user-graduate"></i>
                        <span>{{ course.dynamic_students_count }} student{{ course.dynamic_students_count|pluralize }}</span>
                    </div>

                    <div>
                        <i class="fas fa-globe"></i>
                        <span>{{ course.language }}</span>
                    </div>

                    <div>
                        <i class="fas fa-calendar"></i>
                        <span>Updated {{ course.updated_at|date:"M Y" }}</span>
                    </div>

                    <div>
                        <i class="fas fa-signal"></i>
                        <span>{{ course.get_level_display }}</span>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Course Content -->
<div class="course-content">
    <div class="max-w-7xl mx-auto px-6">
        <div class="flex flex-wrap -mx-4">
            <div class="w-full lg:w-2/3 px-4">
                <!-- Content Tabs -->
                <div class="content-tabs">
                    <ul class="nav nav-tabs" id="courseTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-toggle="tab" data-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                                <i class="fas fa-info-circle icon-gap-xl"></i>Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="curriculum-tab" data-toggle="tab" data-target="#curriculum" type="button" role="tab" aria-controls="curriculum" aria-selected="false">
                                <i class="fas fa-list icon-gap-xl"></i>Curriculum
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="reviews-tab" data-toggle="tab" data-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false">
                                <i class="fas fa-star icon-gap-xl"></i>Reviews
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Tab Content -->
                <div class="tab-content" id="courseTabContent">
                    <!-- Overview Tab -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel">
                        <!-- What you'll learn -->
                        {% if course.learning_objectives %}
                        <div class="learning-objectives">
                            <h3>What you'll learn</h3>
                            <div class="flex flex-wrap -mx-4">
                                <div class="w-full md:w-1/2 px-4">
                                    <ul class="objectives-list">
                                        {% for objective in course.get_learning_objectives_list|slice:":4" %}
                                        <li>
                                            <i class="fas fa-check"></i>
                                            <span>{{ objective }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <div class="w-full md:w-1/2 px-4">
                                    <ul class="objectives-list">
                                        {% for objective in course.get_learning_objectives_list|slice:"4:" %}
                                        <li>
                                            <i class="fas fa-check"></i>
                                            <span>{{ objective }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Requirements and Target Audience -->
                        <div class="requirements-audience">
                            {% if course.prerequisites %}
                            <div class="info-card">
                                <h4>Requirements</h4>
                                <ul class="info-list">
                                    {% for req in course.get_prerequisites_list %}
                                    <li>
                                        <i class="fas fa-check"></i>
                                        <span>{{ req }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}

                            {% if course.target_audience %}
                            <div class="info-card">
                                <h4>Who this course is for</h4>
                                <ul class="info-list">
                                    {% for audience in course.get_target_audience_list %}
                                    <li>
                                        <i class="fas fa-user-check text-green-600"></i>
                                        <span>{{ audience }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Course Description -->
                        <div class="about-course-card">
                            <h3>Course Description</h3>
                            <div class="content-text">
                                {% if course.description %}
                                    {{ course.description|safe }}
                                {% else %}
                                    <p>{{ course.short_description }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Instructor Section (moved here) -->
                        <div class="instructor-section">
                            <h3>Instructor</h3>
                            
                            <!-- Instructor Name and Expertise -->
                            <h4 class="instructor-name">{{ course.instructor.name }}</h4>
                            {% if course.instructor.expertise %}
                                <p class="instructor-expertise">{{ course.instructor.expertise }}</p>
                            {% endif %}
                            
                            <!-- Two Column Layout: Thumbnail Left, Stats Right -->
                            <div class="instructor-profile-layout">
                                <div class="instructor-thumbnail">
                                    {% if course.instructor.profile_image %}
                                        <img src="{{ course.instructor.profile_image.url }}" alt="{{ course.title }}" class="instructor-avatar-large">
                                    {% else %}
                                        <div class="instructor-avatar-large bg-red-600 flex items-center justify-center text-white font-bold" style="font-size: 2rem;">
                                            {{ course.instructor.name|first }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="instructor-stats-column">
                                    <div class="stat-line">
                                        <i class="fas fa-star" style="color: var(--primary-color);"></i>
                                        <span><strong>{{ course.instructor.rating|default:"5.0" }}</strong> Instructor Rating</span>
                                    </div>
                                    {% if course.instructor.reviews_count|default:0 > 0 %}
                                    <div class="stat-line">
                                        <i class="fas fa-comment" style="color: var(--primary-color);"></i>
                                        <span><strong>{{ course.instructor.reviews_count|default:"46,343"|floatformat:0 }}</strong> Reviews</span>
                                    </div>
                                    {% endif %}
                                    <div class="stat-line">
                                        <i class="fas fa-user-graduate" style="color: var(--primary-color);"></i>
                                        <span><strong>{{ course.instructor.dynamic_students_count|floatformat:0 }}</strong> Students</span>
                                    </div>
                                    <div class="stat-line">
                                        <i class="fas fa-play-circle" style="color: var(--primary-color);"></i>
                                        <span><strong>{{ course.instructor.courses_count|default:"1" }}</strong> Courses</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bio underneath -->
                            {% if course.instructor.bio %}
                            <div class="instructor-bio">
                                <p>{{ course.instructor.bio }}</p>
                            </div>
                            {% endif %}

                            {% if course.instructor.linkedin_url or course.instructor.twitter_url or course.instructor.website_url %}
                            <div class="instructor-social mt-16">
                                <h5>Connect with {{ course.instructor.name }}</h5>
                                <div class="social-links mt-12">
                                    {% if course.instructor.linkedin_url %}
                                    <a href="{{ course.instructor.linkedin_url }}" target="_blank" class="inline-flex items-center px-3 py-2 border border-red-600 text-red-600 text-sm rounded-lg hover:bg-red-600 hover:text-white transition-colors duration-300 icon-gap-sm">
                                        <i class="fab fa-linkedin"></i> LinkedIn
                                    </a>
                                    {% endif %}
                                    {% if course.instructor.twitter_url %}
                                    <a href="{{ course.instructor.twitter_url }}" target="_blank" class="inline-flex items-center px-3 py-2 border border-red-600 text-red-600 text-sm rounded-lg hover:bg-red-600 hover:text-white transition-colors duration-300 icon-gap-sm">
                                        <i class="fab fa-twitter"></i> Twitter
                                    </a>
                                    {% endif %}
                                    {% if course.instructor.website_url %}
                                    <a href="{{ course.instructor.website_url }}" target="_blank" class="inline-flex items-center px-3 py-2 border border-red-600 text-red-600 text-sm rounded-lg hover:bg-red-600 hover:text-white transition-colors duration-300">
                                        <i class="fas fa-globe"></i> Website
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Curriculum Tab -->
                    <div class="tab-pane fade" id="curriculum" role="tabpanel">
                        <div class="curriculum-section">
                            <div class="curriculum-header">
                                <h3>Course content</h3>
                                <div class="curriculum-stats">
                                    <span><i class="fas fa-folder icon-gap-lg"></i>{{ course.sections.count }} section{{ course.sections.count|pluralize }}</span>
                                    <span><i class="fas fa-video icon-gap-lg"></i>{{ course.lectures_count }} lecture{{ course.lectures_count|pluralize }}</span>
                                    <span><i class="fas fa-clock icon-gap-lg"></i>{% if course.total_duration and course.total_duration > 0 %}{{ course.total_duration }}{% else %}180{% endif %} minutes total</span>
                                </div>
                            </div>

                            {% for section in course.sections.all %}
                            <div class="section-item">
                                <div class="section-header" onclick="toggleSection({{ section.id }})">
                                    <div class="section-info">
                                        <div class="section-title">
                                            <strong>Section {{ forloop.counter }}: {{ section.title }}</strong>
                                        </div>
                                        <div class="section-stats">
                                            <span><i class="fas fa-play-circle icon-gap-sm"></i>{{ section.lectures.count }} lecture{{ section.lectures.count|pluralize }}</span>
                                            {% if section.get_total_duration %}
                                            <span><i class="fas fa-clock icon-gap-sm"></i>{{ section.get_total_duration }} min</span>
                                            {% endif %}
                                            {% if section.description %}
                                            <span class="section-description">| {{ section.description|truncatechars:60 }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-down chevron-icon" id="chevron-{{ section.id }}"></i>
                                </div>
                                <div class="lectures-list" id="lectures-{{ section.id }}">
                                    {% for lecture in section.lectures.all %}
                                    <div class="lecture-item">
                                        <div class="lecture-info">
                                            {% if section.is_active and lecture.is_preview or section.is_active and user_enrolled %}
                                                <i class="fas fa-play-circle lecture-icon text-green-600"></i>
                                            {% else %}
                                                <i class="fas fa-lock lecture-icon"></i>
                                            {% endif %}
                                            <span class="lecture-title">{{ lecture.title }}</span>
                                        </div>
                                        <div class="lecture-meta">
                                            {% if section.is_active and lecture.is_preview %}
                                                <a href="#" class="preview-lecture" onclick="playPreviewLecture('{{ lecture.video_url }}')">
                                                    <i class="fas fa-eye icon-gap-sm"></i>Preview
                                                </a>
                                            {% elif section.is_active and user_enrolled %}
                                                <a href="#" class="play-lecture" onclick="playLecture('{{ lecture.video_url }}')">
                                                    <i class="fas fa-play icon-gap-sm"></i>Start
                                                </a>
                                            {% endif %}
                                            
                                            {% comment %} Show Resource button if attachments or content links are available {% endcomment %}
                                            {% if lecture.attachments or lecture.content %}
                                                {% if section.is_active and lecture.is_preview or section.is_active and user_enrolled %}
                                                    <a href="#" class="lecture-resource" onclick="showLectureResources({{ lecture.id }}, '{{ lecture.title|escapejs }}')">
                                                        <i class="fas fa-paperclip icon-gap-sm"></i>Resource
                                                    </a>
                                                {% endif %}
                                            {% endif %}
                                            
                                            {% if lecture.duration %}
                                                <span class="lecture-duration">
                                                    <i class="fas fa-clock icon-gap-sm"></i>{{ lecture.duration }} min
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% empty %}
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-book-open"></i>
                                </div>
                                <h4>Course curriculum coming soon</h4>
                                <p>We're preparing comprehensive course content for you. Check back soon!</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Reviews Tab -->
                    <div class="tab-pane fade" id="reviews" role="tabpanel">
                        <div class="reviews-section">
                            <div class="reviews-header">
                                <h3>Student feedback</h3>
                                {% if course.rating > 0 %}
                                <div class="overall-rating">
                                    <div class="rating-summary">
                                        <div class="rating-score">
                                            <span class="score-number">{{ course.rating }}</span>
                                            <div class="score-stars">
                                                {% for i in "12345" %}
                                                    {% if forloop.counter <= course.rating|floatformat:0 %}
                                                        <i class="fas fa-star"></i>
                                                    {% elif forloop.counter <= course.rating|add:0.5 %}
                                                        <i class="fas fa-star-half-alt"></i>
                                                    {% else %}
                                                        <i class="far fa-star"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            <p class="rating-text">Course Rating</p>
                                        </div>
                                        <div class="rating-breakdown">
                                            <div class="rating-bar">
                                                <span class="bar-label">5 stars</span>
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 75%"></div>
                                                </div>
                                                <span class="bar-percentage">75%</span>
                                            </div>
                                            <div class="rating-bar">
                                                <span class="bar-label">4 stars</span>
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 20%"></div>
                                                </div>
                                                <span class="bar-percentage">20%</span>
                                            </div>
                                            <div class="rating-bar">
                                                <span class="bar-label">3 stars</span>
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 3%"></div>
                                                </div>
                                                <span class="bar-percentage">3%</span>
                                            </div>
                                            <div class="rating-bar">
                                                <span class="bar-label">2 stars</span>
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 2%"></div>
                                                </div>
                                                <span class="bar-percentage">2%</span>
                                            </div>
                                            <div class="rating-bar">
                                                <span class="bar-label">1 star</span>
                                                <div class="progress">
                                                    <div class="progress-bar" style="width: 0%"></div>
                                                </div>
                                                <span class="bar-percentage">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if course.reviews.count > 0 %}
                                <div class="reviews-list">
                                    {% for review in reviews %}
                                    <div class="review-item">
                                        <div class="review-header">
                                            <div class="reviewer-info">
                                                <div class="reviewer-avatar">
                                                    {% if review.user.userprofile.profile_image %}
                                                        <img src="{{ review.user.userprofile.profile_image.url }}" alt="{{ course.title }}">
                                                    {% else %}
                                                        <div class="avatar-placeholder">
                                                            {{ review.user.first_name|first|upper }}{{ review.user.last_name|first|upper|default:review.user.username|first|upper }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="reviewer-details">
                                                    <h6 class="reviewer-name">{{ review.student_name }}</h6>
                                                    <div class="review-rating">
                                                        {% for i in "12345" %}
                                                            {% if forloop.counter <= review.rating %}
                                                                <i class="fas fa-star"></i>
                                                            {% else %}
                                                                <i class="far fa-star"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    <span class="review-date">{{ review.created_at|date:"M d, Y" }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="review-content">
                                            <p>{{ review.review_text }}</p>
                                        </div>
                                        <div class="review-actions">
                                            {% if user.is_authenticated %}
                                                <button class="review-action-btn {% if review.user_found_helpful %}liked{% endif %}" 
                                                        onclick="toggleHelpful({{ review.id }})" 
                                                        id="like-btn-{{ review.id }}"
                                                        data-review-id="{{ review.id }}"
                                                        data-is-helpful="{{ review.user_found_helpful|yesno:'true,false' }}">
                                                    {% if review.user_found_helpful %}
                                                        <i class="fas fa-thumbs-up"></i>
                                                    {% else %}
                                                        <i class="far fa-thumbs-up"></i>
                                                    {% endif %}
                                                    Helpful 
                                                    <span class="helpful-count" id="count-{{ review.id }}">({{ review.helpful_count }})</span>
                                                </button>
                                            {% else %}
                                                <span class="review-action-btn" style="cursor: default;">
                                                    <i class="far fa-thumbs-up"></i> Helpful ({{ review.helpful_count }})
                                                </span>
                                            {% endif %}
                                            <button class="review-action-btn" onclick="reportReview({{ review.id }})">
                                                <i class="far fa-flag"></i> Report
                                            </button>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            <!-- Review Form Section -->
                            {% if user.is_authenticated %}
                                {% if can_review %}
                                    <div class="review-form-section mt-16">
                                        <h4>Write a Review</h4>
                                        <form id="reviewForm" class="review-form">
                                            {% csrf_token %}
                                            <div class="mb-6">
                                                <label class="block mb-2 font-semibold">Your Rating</label>
                                                <div class="star-rating-input">
                                                    {% for i in "12345" %}
                                                        <input type="radio" name="rating" value="{{ forloop.counter }}" id="star{{ forloop.counter }}" required>
                                                        <label for="star{{ forloop.counter }}" class="star-label">
                                                            <i class="fas fa-star"></i>
                                                        </label>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="mb-6">
                                                {{ review_form.review_text.label_tag }}
                                                {{ review_form.review_text }}
                                            </div>
                                            <button type="submit" class="inline-flex items-center px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors duration-300">
                                                <i class="fas fa-paper-plane mr-2"></i>Submit Review
                                            </button>
                                        </form>
                                    </div>
                                {% elif user_review %}
                                    <div class="user-review-section mt-16">
                                        <h4>Your Review</h4>
                                        <div class="review-item user-review">
                                            <div class="review-header">
                                                <div class="reviewer-info">
                                                    <div class="reviewer-details">
                                                        <h6 class="reviewer-name">{{ user_review.student_name }}</h6>
                                                        <div class="review-rating">
                                                            {% for i in "12345" %}
                                                                {% if forloop.counter <= user_review.rating %}
                                                                    <i class="fas fa-star"></i>
                                                                {% else %}
                                                                    <i class="far fa-star"></i>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                        <span class="review-date">{{ user_review.created_at|date:"M d, Y" }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="review-content">
                                                <p>{{ user_review.review_text }}</p>
                                            </div>
                                        </div>
                                    </div>
                                {% elif not user_enrolled %}
                                    <div class="enrollment-required mt-16">
                                        <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg flex items-start">
                                            <i class="fas fa-info-circle mr-2 mt-1"></i>
                                            <span>You must enroll in this course to leave a review.</span>
                                        </div>
                                    </div>
                                {% endif %}
                            {% else %}
                                {% if course.reviews.count == 0 %}
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <h4>No reviews yet</h4>
                                <p>Be the first to review this course and help other students!</p>
                                <a href="{% url 'login' %}" class="inline-flex items-center px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors duration-300">
                                    <i class="fas fa-sign-in-alt mr-2"></i>Login to Review
                                </a>
                            </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="w-full lg:w-1/3 px-4">
                <div class="course-sidebar">
                    <!-- Preview Video -->
                    <div class="preview-video" onclick="playPreview()">
                        {% if course.thumbnail %}
                            <img src="{{ course.thumbnail.url }}" alt="{{ course.title }}">
                        {% else %}
                            <div class="bg-gray-900 w-full h-full flex items-center justify-center">
                                <i class="fas fa-graduation-cap text-white" style="font-size: 3rem;"></i>
                            </div>
                        {% endif %}
                        <div class="play-button">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>

                    <!-- Course Price -->
                    <div class="course-price">
                        <div class="price-section">
                            {% if course.is_free %}
                                <span class="current-price">Free</span>
                            {% else %}
                                <span class="current-price">₦{{ course.price|floatformat:0|intcomma }}</span>
                                {% if course.original_price and course.original_price > course.price %}
                                    <span class="original-price">₦{{ course.original_price|floatformat:0|intcomma }}</span>
                                    <span class="discount-badge">{{ course.get_discount_percentage }}% off</span>
                                {% endif %}
                            {% endif %}
                        </div>

                        {% if user.is_authenticated %}
                            {% if user_enrolled %}
                                <button class="enroll-btn enrolled" disabled>
                                    <i class="fas fa-check icon-gap-xl"></i>Enrolled
                                </button>
                            {% elif has_pending_payment %}
                                <!-- Hidden CSRF token for AJAX requests -->
                                {% csrf_token %}
                                <div class="pending-payment-section">
                                    <button class="enroll-btn" onclick="processCoursePayment({{ course.id }})" id="pendingPaymentBtn" style="background: #ffc107; border-color: #ffc107;">
                                        <i class="fas fa-clock icon-gap-xl"></i>Payment Pending
                                    </button>
                                </div>
                            {% else %}
                                <!-- Hidden CSRF token for AJAX requests -->
                                {% csrf_token %}
                                {% if course.is_free %}
                                    <button class="enroll-btn" onclick="enrollInCourse({{ course.id }})" id="enrollBtn">
                                        <i class="fas fa-user-plus icon-gap-xl"></i>Enroll for free
                                    </button>
                                {% else %}
                                    <button class="enroll-btn" onclick="processCoursePayment({{ course.id }})" id="paymentBtn">
                                        <i class="fas fa-shopping-cart icon-gap-xl"></i>Buy Now - ₦{{ course.price|floatformat:0|intcomma }}
                                    </button>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <a href="{% url 'signup' %}?course_id={{ course.id }}&next={{ request.path }}" class="enroll-btn">
                                <i class="fas fa-user-plus icon-gap-xl"></i>Sign Up to Enroll
                            </a>
                            <div class="text-center mt-1">
                                <small>Already have an account? <a href="{% url 'login' %}?course_id={{ course.id }}&next={{ request.path }}" style="color: var(--primary-color); text-decoration: none;">Login here</a></small>
                            </div>
                        {% endif %}

                        <!-- This course includes -->
                        <div class="mb-12 mt-16">
                            <h6 style="font-size: 0.9rem;"><i class="fas fa-gift icon-gap-xl"></i>This course includes:</h6>
                            <ul class="course-includes">
                                <li>
                                    <i class="fas fa-video"></i>
                                    <span>{% if course.total_duration and course.total_duration > 0 %}{{ course.total_duration }}{% else %}180{% endif %} minutes on-demand video</span>
                                </li>
                                <li>
                                    <i class="fas fa-calendar-check"></i>
                                    <span>1 Year course access</span>
                                </li>
                                <li>
                                    <i class="fas fa-certificate"></i>
                                    <span>Certificate of completion</span>
                                </li>
                                <li>
                                    <i class="fas fa-users"></i>
                                    <span>Access to course community</span>
                                </li>
                                <li>
                                    <i class="fas fa-user-graduate"></i>
                                    <span>Exclusive mentorship for 1 month</span>
                                </li>
                            </ul>
                        </div>

                        <!-- Share Course -->
                        <div class="share-section">
                            <h6 style="font-size: 0.9rem;"><i class="fas fa-share-alt icon-gap-xl"></i>Share this course</h6>
                            <div class="share-buttons">
                                <a href="#" class="share-btn" onclick="event.preventDefault(); shareOnFacebook();" title="Share on Facebook">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                <a href="#" class="share-btn" onclick="event.preventDefault(); shareOnTwitter();" title="Share on Twitter">
                                    <i class="fab fa-twitter"></i>
                                </a>
                                <a href="#" class="share-btn" onclick="event.preventDefault(); shareOnLinkedIn();" title="Share on LinkedIn">
                                    <i class="fab fa-linkedin-in"></i>
                                </a>
                                <a href="#" class="share-btn" onclick="event.preventDefault(); shareOnWhatsApp();" title="Share on WhatsApp">
                                    <i class="fab fa-whatsapp"></i>
                                </a>
                                <a href="#" class="share-btn" onclick="event.preventDefault(); copyLink();" title="Copy link">
                                    <i class="fas fa-link"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resource Modal -->
<div class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center" id="resourceModal" tabindex="-1" role="dialog" aria-labelledby="resourceModalLabel" aria-hidden="true">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4" role="document">
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h5 class="text-xl font-semibold text-gray-900" id="resourceModalTitle">Lecture Resources</h5>
            <button type="button" class="text-gray-400 hover:text-gray-600 text-2xl font-bold leading-none" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="p-6" id="resourceModalBody">
            <!-- Resources will be loaded here -->
        </div>
        <div class="flex items-center justify-end p-6 border-t border-gray-200">
            <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-300" data-dismiss="modal">Close</button>
        </div>
    </div>
</div>

<style>
.resource-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
}

.resource-item i {
    color: #EF233C;
    margin-right: 0.5rem;
}

.resource-item span {
    flex: 1;
    font-size: 0.9rem;
}

.resource-content {
    background: white;
    padding: 0.75rem;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    margin-top: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
}

.resource-content h1, .resource-content h2, .resource-content h3,
.resource-content h4, .resource-content h5, .resource-content h6 {
    color: #333;
    margin-top: 0.75rem;
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.resource-content p {
    margin-bottom: 0.5rem;
    line-height: 1.5;
    font-size: 0.9rem;
}

.resource-content a {
    color: #EF233C;
    text-decoration: underline;
}

.resource-content a:hover {
    color: #d01f37;
}

#resourceModalBody h6 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    color: #333;
    font-size: 0.95rem;
    font-weight: 600;
}

#resourceModalBody h6:first-child {
    margin-top: 0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// TikTok Tracking - ViewContent Event
document.addEventListener('DOMContentLoaded', function() {
    // Track course view content
    if (typeof ttq !== 'undefined') {
        {% if user.is_authenticated %}
        // Identify user if logged in
        ttq.identify({
            "external_id": "{{ user.id|default:'' }}" // User ID as external identifier
        });
        {% endif %}
        
        // Track ViewContent event
        ttq.track('ViewContent', {
            "contents": [
                {
                    "content_id": "{{ course.id }}", 
                    "content_type": "product", 
                    "content_name": "{{ course.title|escapejs }}"
                }
            ],
            "value": {{ course.price|default:0 }}, 
            "currency": "NGN"
        });
    }
});

// Course functionality
document.addEventListener('DOMContentLoaded', function() {
    // All sections start closed by default

    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Tab persistence in URL
    // Handle hash-based tab switching on page load
    const hash = window.location.hash;
    if (hash) {
        const tabTrigger = document.querySelector(`[data-target="${hash}"]`);
        if (tabTrigger) {
            tabTrigger.click();
        }
    }

    // Tab functionality - Pure JavaScript (no Bootstrap required)
    document.querySelectorAll('[data-toggle="tab"]').forEach(tab => {
        tab.addEventListener('click', function (e) {
            e.preventDefault();
            
            const targetId = this.getAttribute('data-target');
            const targetPane = document.querySelector(targetId);
            
            if (!targetPane) return;
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-link').forEach(navLink => {
                navLink.classList.remove('active');
                navLink.setAttribute('aria-selected', 'false');
            });
            
            // Add active class to clicked tab
            this.classList.add('active');
            this.setAttribute('aria-selected', 'true');
            
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });
            
            // Show target tab pane
            targetPane.classList.add('show', 'active');
            
            // Update URL hash
            history.replaceState(null, null, targetId);
        });
    });
});

// Toggle curriculum sections
function toggleSection(sectionId) {
    const lecturesList = document.getElementById(`lectures-${sectionId}`);
    const chevron = document.getElementById(`chevron-${sectionId}`);
    const sectionHeader = chevron.closest('.section-header');
    
    if (lecturesList && chevron) {
        if (lecturesList.classList.contains('show')) {
            // Collapse
            lecturesList.style.maxHeight = '0px';
            lecturesList.classList.remove('show');
            chevron.classList.remove('rotated');
            sectionHeader.classList.remove('active');
        } else {
            // Expand - calculate exact height needed
            lecturesList.style.maxHeight = 'none';
            const height = lecturesList.scrollHeight;
            lecturesList.style.maxHeight = '0px';
            
            // Force reflow then animate to calculated height
            lecturesList.offsetHeight;
            lecturesList.style.maxHeight = height + 'px';
            
            lecturesList.classList.add('show');
            chevron.classList.add('rotated');
            sectionHeader.classList.add('active');
        }
    }
}

// Expand all curriculum sections
function expandAllSections() {
    document.querySelectorAll('.lectures-list').forEach(list => {
        if (!list.classList.contains('show')) {
            // Calculate height and expand
            list.style.maxHeight = 'none';
            const height = list.scrollHeight;
            list.style.maxHeight = '0px';
            list.offsetHeight; // Force reflow
            list.style.maxHeight = height + 'px';
            list.classList.add('show');
        }
    });
    document.querySelectorAll('.chevron-icon').forEach(chevron => {
        chevron.classList.add('rotated');
    });
    document.querySelectorAll('.section-header').forEach(header => {
        header.classList.add('active');
    });
}

// Collapse all curriculum sections
function collapseAllSections() {
    document.querySelectorAll('.lectures-list').forEach(list => {
        list.style.maxHeight = '0px';
        list.classList.remove('show');
    });
    document.querySelectorAll('.chevron-icon').forEach(chevron => {
        chevron.classList.remove('rotated');
    });
    document.querySelectorAll('.section-header').forEach(header => {
        header.classList.remove('active');
    });
}

// Reviews functionality
function toggleHelpful(reviewId) {
    console.log('toggleHelpful called with reviewId:', reviewId);
    
    const btn = document.getElementById(`like-btn-${reviewId}`);
    const countSpan = document.getElementById(`count-${reviewId}`);
    const icon = btn.querySelector('i');
    
    console.log('Button found:', btn);
    console.log('Current helpful state:', btn.dataset.isHelpful);
    
    // Make AJAX request immediately without loading state
    fetch(`/review/${reviewId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Toggle helpful response:', data);
        if (data.success) {
            // Update count
            countSpan.textContent = `(${data.helpful_count})`;
            
            if (data.is_helpful) {
                // User marked as helpful
                console.log('Setting to helpful state');
                icon.className = 'fas fa-thumbs-up';
                btn.classList.add('liked');
                btn.style.color = '#28a745';
                btn.dataset.isHelpful = 'true';
            } else {
                // User removed helpful
                console.log('Setting to not helpful state');
                icon.className = 'far fa-thumbs-up';
                btn.classList.remove('liked');
                btn.style.color = '';
                btn.dataset.isHelpful = 'false';
            }
            
            // Show subtle notification
            showNotification(data.message, 'success');
        } else {
            console.error('Toggle failed:', data);
            showNotification(data.error || 'Failed to record your feedback.', 'error');
        }
    })
    .catch(error => {
        console.error('Toggle helpful error:', error);
        showNotification('An error occurred. Please try again.', 'error');
    });
}

function reportReview(reviewId) {
    if (confirm('Are you sure you want to report this review?')) {
        showNotification('Review reported. Thank you for your feedback.', 'info');
    }
}

function showReviewForm() {
    showNotification('Review form coming soon! Check back later.', 'info');
}

// Play preview video
function playPreview() {
    {% if course.preview_video %}
        // Use direct navigation to allow mobile apps to intercept
        window.location.href = '{{ course.preview_video }}';
    {% else %}
        showNotification('Preview video will be available soon!', 'info');
    {% endif %}
}

// Play preview lecture
function playPreviewLecture(videoUrl) {
    if (videoUrl) {
        // Use direct navigation to allow mobile apps to intercept
        window.location.href = videoUrl;
    } else {
        showNotification('Preview will be available soon!', 'info');
    }
}

// Play full lecture (for enrolled users)
function playLecture(videoUrl) {
    if (videoUrl) {
        // Use direct navigation to allow mobile apps to intercept
        window.location.href = videoUrl;
    } else {
        showNotification('Lecture video will be available soon!', 'info');
    }
}

// Show lecture resources (attachments and content)
function showLectureResources(lectureId, lectureTitle) {
    // Fetch lecture resources
    fetch(`/lecture/${lectureId}/resources/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showResourceModal(lectureTitle, data.resources);
            } else {
                showNotification('Error loading resources', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error loading resources', 'error');
        });
}

// Show resource modal
function showResourceModal(lectureTitle, resources) {
    const modal = document.getElementById('resourceModal');
    const modalTitle = document.getElementById('resourceModalTitle');
    const modalBody = document.getElementById('resourceModalBody');
    
    modalTitle.textContent = `${lectureTitle} - Resources`;
    
    let resourcesHtml = '';
    
    if (resources.attachments && resources.attachments.length > 0) {
        resourcesHtml += '<h6><i class="fas fa-paperclip"></i> Downloads</h6>';
        resources.attachments.forEach(attachment => {
            resourcesHtml += `
                <div class="resource-item">
                    <i class="fas fa-file-pdf"></i>
                    <span>${attachment.name}</span>
                    <a href="${attachment.url}" class="inline-flex items-center px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors duration-300" download>
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
            `;
        });
    }
    
    if (resources.content) {
        resourcesHtml += '<h6><i class="fas fa-file-text"></i> Additional Content</h6>';
        resourcesHtml += `<div class="resource-content">${resources.content}</div>`;
    }
    
    if (!resourcesHtml) {
        resourcesHtml = '<p>No resources available for this lecture.</p>';
    }
    
    modalBody.innerHTML = resourcesHtml;
    $('#resourceModal').modal('show');
}

// Enrollment functionality
function enrollInCourse(courseId) {
    const btn = document.getElementById('enrollBtn');
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.innerHTML = '<span class="spinner icon-gap-sm"></span>Processing...';
    btn.classList.add('loading');
    btn.disabled = true;
    
    // Make AJAX request to enroll
    fetch(`/course/enroll/${courseId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // TikTok Tracking - AddToCart Event for Free Course Enrollment
            if (typeof ttq !== 'undefined') {
                ttq.track('AddToCart', {
                    "contents": [
                        {
                            "content_id": "{{ course.id }}", 
                            "content_type": "product", 
                            "content_name": "{{ course.title|escapejs }}"
                        }
                    ],
                    "value": 0, // Free course
                    "currency": "NGN"
                });
            }
            
            showNotification(data.message, 'success');
            btn.innerHTML = '<i class="fas fa-check icon-gap-sm"></i>Enrolled';
            btn.style.background = '#28a745';
            btn.disabled = true;
            // Reload page to update review section
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showNotification(data.message || 'Enrollment failed. Please try again.', 'error');
            btn.innerHTML = originalText;
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred. Please try again.', 'error');
        btn.innerHTML = originalText;
        btn.classList.remove('loading');
        btn.disabled = false;
    });
}

// Payment processing functionality
function processCoursePayment(courseId) {
    // Try to find the payment button (could be paymentBtn or pendingPaymentBtn)
    let btn = document.getElementById('paymentBtn');
    if (!btn) {
        btn = document.getElementById('pendingPaymentBtn');
    }
    
    if (!btn) {
        console.error('Payment button not found');
        alert('Payment button not found. Please refresh the page and try again.');
        return;
    }
    
    const originalText = btn.innerHTML;
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('CSRF token not found');
        alert('Security token not found. Please refresh the page and try again.');
        return;
    }
    
    console.log('Starting payment process for course:', courseId);
    
    // Show loading state
    btn.innerHTML = '<span class="spinner icon-gap-sm"></span>Processing...';
    btn.classList.add('loading');
    btn.disabled = true;
    
    // Make AJAX request to process payment
    fetch('/payment/process/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken.value,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            'course_id': courseId,
            'payment_method': 'kora_pay'
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Payment response:', data);
        if (data.success && data.payment_url) {
            // TikTok Tracking - InitiateCheckout Event
            if (typeof ttq !== 'undefined') {
                ttq.track('InitiateCheckout', {
                    "contents": [
                        {
                            "content_id": "{{ course.id }}", 
                            "content_type": "product", 
                            "content_name": "{{ course.title|escapejs }}"
                        }
                    ],
                    "value": {{ course.price|default:0 }}, 
                    "currency": "NGN"
                });
            }
            
            console.log('Redirecting to:', data.payment_url);
            // Redirect to Kora Pay checkout
            window.location.href = data.payment_url;
        } else {
            const errorMsg = data.error || 'Payment initialization failed. Please try again.';
            console.error('Payment failed:', errorMsg);
            if (typeof showNotification === 'function') {
                showNotification(errorMsg, 'error');
            } else {
                alert(errorMsg);
            }
            btn.innerHTML = originalText;
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Payment error:', error);
        const errorMsg = 'An error occurred. Please try again.';
        if (typeof showNotification === 'function') {
            showNotification(errorMsg, 'error');
        } else {
            alert(errorMsg);
        }
        btn.innerHTML = originalText;
        btn.classList.remove('loading');
        btn.disabled = false;
    });
}

// Review form functionality
document.addEventListener('DOMContentLoaded', function() {
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
        reviewForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitReview();
        });
    }
    
    // Star rating interaction
    const starInputs = document.querySelectorAll('.star-rating-input input[type="radio"]');
    const starLabels = document.querySelectorAll('.star-rating-input label');
    
    starLabels.forEach((label, index) => {
        label.addEventListener('mouseenter', function() {
            highlightStars(index + 1);
        });
        
        label.addEventListener('click', function() {
            selectStars(index + 1);
        });
    });
    
    // Add null check for star rating input
    const starRatingInput = document.querySelector('.star-rating-input');
    if (starRatingInput) {
        starRatingInput.addEventListener('mouseleave', function() {
            const checkedInput = document.querySelector('.star-rating-input input:checked');
            if (checkedInput) {
                highlightStars(parseInt(checkedInput.value));
            } else {
                highlightStars(0);
            }
        });
    }
});

function highlightStars(rating) {
    const starLabels = document.querySelectorAll('.star-rating-input label');
    starLabels.forEach((label, index) => {
        if (index < rating) {
            label.classList.add('highlighted');
        } else {
            label.classList.remove('highlighted');
        }
    });
}

function selectStars(rating) {
    const starInputs = document.querySelectorAll('.star-rating-input input[type="radio"]');
    starInputs[rating - 1].checked = true;
    highlightStars(rating);
}

function submitReview() {
    const form = document.getElementById('reviewForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<span class="spinner"></span>Submitting...';
    submitBtn.disabled = true;
    
    // Get form data
    const formData = new FormData(form);
    
    // Make AJAX request
    fetch(`/course/{{ course.id }}/review/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data); // Debug log
        if (data.success) {
            showNotification(data.message, 'success');
            // Reload page to show the new review
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            const errorMsg = data.message || data.error || 'Failed to submit review. Please try again.';
            console.error('Review submission failed:', data);
            showNotification(errorMsg, 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Network or parsing error:', error);
        showNotification('An error occurred. Please try again.', 'error');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Social sharing functions
function shareOnFacebook() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{ course.title }} Course - {{ course.subtitle|escapejs }}');
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`, '_blank', 'width=600,height=400');
}

function shareOnTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent('{{ course.title }} Course - {{ course.subtitle|escapejs }}');
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
}

function shareOnLinkedIn() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{ course.title }} Course - {{ course.subtitle|escapejs }}');
    const summary = encodeURIComponent('{{ course.meta_description|default:course.short_description|escapejs }}');
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}&title=${title}&summary=${summary}`, '_blank', 'width=600,height=400');
}

function shareOnWhatsApp() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent('{{ course.title }} Course - {{ course.subtitle|escapejs }}');
    window.open(`https://wa.me/?text=${text} ${url}`, '_blank');
}

function copyLink() {
    // Remove hash from URL if present
    const url = window.location.href.split('#')[0];
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        // Modern clipboard API
        navigator.clipboard.writeText(url).then(() => {
            showNotification('Link copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            // Fallback if clipboard API fails
            fallbackCopyToClipboard(url);
        });
    } else {
        // Fallback for older browsers
        fallbackCopyToClipboard(url);
    }
}

function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.top = '-9999px';
    textArea.style.left = '-9999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showNotification('Link copied to clipboard!', 'success');
        } else {
            showNotification('Failed to copy link', 'error');
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showNotification('Failed to copy link', 'error');
    }
    
    document.body.removeChild(textArea);
}

// Notification system - Updated for Tailwind CSS
function showNotification(message, type = 'info') {
    // Color schemes for different notification types
    const typeStyles = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        warning: 'bg-yellow-500 text-white',
        info: 'bg-blue-500 text-white'
    };
    
    const notification = document.createElement('div');
    notification.className = `${typeStyles[type] || typeStyles.info} px-6 py-4 rounded-lg shadow-2xl fixed top-20 right-4 z-[9999] min-w-[300px] max-w-[400px] flex items-center justify-between transform transition-all duration-300 ease-in-out`;
    notification.style.animation = 'slideInRight 0.3s ease-out';
    
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} text-xl"></i>
            <span class="font-medium">${message}</span>
        </div>
        <button type="button" class="ml-4 text-white hover:text-gray-200 transition-colors" onclick="this.parentElement.remove()">
            <i class="fas fa-times text-lg"></i>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds with fade out animation
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }
    }, 5000);
}

// Add animation keyframes
if (!document.getElementById('notification-animations')) {
    const style = document.createElement('style');
    style.id = 'notification-animations';
    style.textContent = `
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    `;
    document.head.appendChild(style);
}

// Lazy loading for images
if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove('lazy');
                imageObserver.unobserve(img);
            }
        });
    });

    document.querySelectorAll('img[data-src]').forEach(img => {
        imageObserver.observe(img);
    });
}

// Course progress tracking (for future implementation)
function trackProgress(action, data = {}) {
    // This would send analytics data to your backend
    console.log('Course action:', action, data);
}

// Track page view
trackProgress('page_view', {
    course_id: '{{ course.id }}',
    course_title: '{{ course.title }}',
    instructor: '{{ course.instructor.name }}'
});
</script>
{% endblock %}